# 레디스 프로토콜

- 레디스 서버가 수신하는 모든 명령은 레디스 프로토콜을 통해 송수신됨
- 데이터 통신을 위한 채널은 `TCP/IP`
- 레디스 서버의 환경파일에 기재된 포트를 사용
- HTTP처럼 텍스트 기반 프로토콜

***

## 프로토콜 구조

- 레디스 프로토콜은 binary-safe함
  - 전송되는 데이터에 따라서 프로토콜이 오작동하지 않음
  - ex) 구분자로 `\n`을 사용하는 경우 줄바꿈이 포함되어 데이터 전송에 문제가 나는 상황이 없음

***

## 전송 프로토콜

```redis
*<인자의 개수> (CRLF)
$<첫 번째 인자의 바이트 수(글자 수)> (CRLF)
<인자> (CRLF)
$<두 번째 인자의 바이트 수> (CRLF)
<인자> (CRLF)
...
```

- 모든 정보는 줄바꿈으로 구분 됨
- 첫 번째로 전송할 인자의 개수를 표시
  - `*`문자로 시작하며 다음으로 인자의 개수 표시
- 인자의 정보는 인자의 길이와 인자 데이터로 이루어짐

```redis
# set mykey value1 명령의 프로토콜
*3
$3
set
$5
mykey
$6
value1
```

***

## 수신 프로토콜

- 수신 프로토콜 구조는 매우 단순
- 첫 번째 1바이트의 값이 응답 데이터의 종류를 의미
- 응답 데이터의 종류에 따라서 응답 프로토콜의 구조가 달라짐

| 응답 구분자 | 설명                                       |
| :----- | :--------------------------------------- |
| +      | 상태 응답 (요청된 명령의 처리 결과에 대한 상태 메시지)         |
| -      | 에러 응답 (요청된 명령이 실패했을 때 실패의 원인에 대한 에러 메시지) |
| :      | 숫자 응답 (요청된 명령에 처리 결과를 숫자로 반환)            |
| $      | 단일 벌크응답 (데이터의 크기를 포함한 데이터 반환)            |
| *      | 멀티 벌크응답 (응답되는 데이터 개수 반환)                 |

- `PuTTY`를 통해 레디스 서버로 `Raw` 연결하여 테스트

```redis
*3
$3
set
$4
key1
$7
myvalue   <- (1)
+OK       <- (2)
```

- (1)부분 까지가 레디스 서버로의 입력
- (2)부분은 입력에 대한 레디스 서버로부터의 응답
- 실제로 위의 명령 후 redis-cli에서 확인하면 데이터가 추가 되었음을 확인할 수 있음

```redis
127.0.0.1:6379> get key1
"myvalue"
```

- 상태 데이터 응답
  - `OK` 같은 상태를 응답
  - `+`로 시작

- 에러 응답
  - 레디스 서버에서 명령 처리에 오류 발생시 전송됨
  - `-`로 시작

```redis
*3
$3
get
$4
key1
$7
myvalue
-ERR wrong number of arguments for 'get' command
```

- 숫자 응답
  - 실행된 명령의 결과사 숫자일 때의 응답
  - `:`으로 시작
  - 반환 값을 문자열로 처리하여 반환함 (120이라고 0x80이 아닌 문자열 '120'으로 반환)

```redis
*3
$6
append
$4
key1
$3
123
:10   # append 명령을 통해 데이터 추가 후 저장된 데이터의 전체 바이트 수 반환
```

- 벌크응답
  - 바이너리 세이프 문자열의 응답에 사용됨
  - `$`로 시작하여 두 줄로 반환
  - 응답 크기로 `$`로 시작하여 바이트 수가 나오며 다음줄에 문자열이 따라옴

```redis
*3
$3
get
$4
key1
$10   # 반환되는 문자열의 크기가 10바이트
myvalue123
```

- 멀티 벌크응답
  - 여러 개의 바이너리 세이프 문자열을 응답하는데 사용됨
  - 벌크응답과 유사
  - 전송 프로토콜과 동일
  - `*`로 시작하며 반환할 문자열의 개수가 표시됨

```redis
*3
$4
mget
$4
key1
$4
key9
*2    # 반환할 데이터의 개수가 2개
$10
myvalue123
$-1   # 두 번째 키인 key9에 해당하는 값이 존재하지 않기 때문에 -1 반환 (nil과 동일)
```

```redis
127.0.0.1:6379> mget key1 key9
1) "myvalue1"
2) (nil)
```
