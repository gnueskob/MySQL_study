# 레디스 튜닝

## 환경 설정

- 레디스의 환경설정은 두 가지 변경 방법 존재
  - `redis.conf`설정 변경 후 레디스 프로세스 시작 시 로드
  - `config set`명령을 통해 실시간으로 변경
- 단위 기호중 `k`, `kb` 처럼 두 가지 단위 존재
  - 일반 단위는 `1,000` 단위
  - 뒤에 `b`가 붙은 단위는 `2^10(1,024)` 기준

### 기본 설정

- `port`
  - 인스턴스가 사용할 서비스 포트 지정
  - 미사용시 포트 기본값 6379

- `bind`
  - 인스턴스가 사용할 네트워크 어댑터 지정
  - 하나의 하드웨어에 여러 네트워크 카드를 설치하여 별도의 네트워크 어댑터사용
  - 그 중 레디스가 사용할 네트워크 어댑터 지정
    - 참고 : 10_Redis_운영.md - 네트워크

- `timeout`
  - 연결된 클라이언트의 `idle`대기 시간 (초단위)
  - 지정된 시간 동안 데이터 송수신이 발생하지 않으면 연결 종료
  - 0으로 지정시 해당 기능은 작동하지 않음

- `loglevel`
  - 레디스 동작 중에 출력하는 로그의 레벨 지정
  - `debug`, `verbose`, `notice(default)`, `warning` 존재

- `logfile`
  - 로그가 저장되는 경로, 파일 지정
  - 로그 파일의 기본값은 리눅스 표준 출력 `stdout`
  - 파일로 따로 저장하기를 원할 경우 이 설정에 파일 이름 지정

- `databases`
  - 레디스는 `databases`라는 이름의 논리적으로 분리된 데이터 저장공간 제공
  - RDBMS 스키마와 유사한 개념이며 숫자로 구분됨
  - 각 클라이언트 연결이 사용할 database를 지정하기 위해 `select`명령 사용
  - 데이터의 저장, 조회는 선택된 database에서 처리됨
  - 기본값 16 (16개의 분리된 데이터 저장공간)

***

## 스냅샷 설정

- 레디스는 데이터를 영구 저장하기 위해 `dump.rdb`파일에 메모리 내용 기록

- `save <단위시간> <키의 변경 횟수>`
  - 레디스의 스냅샷 이벤트가 발생하는 간격 지정
  - 레디스는 스냅샷 이벤트가 발생하면 `dump.rdb`에 메모리 데이터 저장
  - 단위시간동안 키의 변경 횟수가 일정 횟수 이상이면 이벤트 발생
  - 여러개의 `save` 설정 사용 가능 (하나라도 만족하면 이벤트 발생)
  - 빈 문자열 `""`을 사용할 경우 스냅샷 미사용

- `stop-writes-on-bgsave-error`
  - 스냅샷 이벤트 중 `dump.rdb`파일을 저장시 오류가 발생하면 모든 쓰기 요청이 거부됨
  - 스냅샷 파일 생성에 실패하더라도 쓰기요청 처리를 원할 시 해당 설정은 `no`로 지정

- `rdbcompression`
  - 스냅샷 파일을 저장할 때 압축 여부 지정
  - 압축에 사용되는 알고리즘 `LZH`
  - 기본값 : `yes`

- `rdbchecksum`
  - 스냅샷 파일 정합성 검증 사용 여부 지정
  - v2.6 기준 파일의 마지막에 CRC64 체크섬값 기록
  - 기본값 : `yes`

- `dir`
  - 레디스의 작업 디렉토리 지정
  - 기본값 : `./`

- `dbfilename`
  - 스냅샷 파일명 지정
  - 경로까지 포함 가능하며 경로가 존재하지 않을 시 스냅샷 파일 저장 실패
  - 기본값 : `dump.rdb`

***

## AOF 설정

- 스냅샷 사용 중 레디스 장애 발생시 최종 스냅샷 파일이 저장된 이후 내용을 잃어버림
- aof 파일은 레디스에서 발생한 모든 데이터의 변경 이력을 저장하고 있음
- 쓰기 명령어가 실행될 때마다 aof 파일에 명령과 데이터를 기록
- AOF 파일 구조는 레디스 프로토콜 구조와 동일

- `appendonly`
  - AOF 기능 사용 여부 지정
  - 기본값 : `no`

- `appendfilename`
  - aof 파일명 지정
  - 경로 포함 가능

- `appendfsync`
  - 출력 버퍼가 바로 파일에 기록하는지 여부 지정
  - `no` : 레디스가 `fsync`함수를 호출하지 않음 (OS에서 알아서 파일에 저장, 안정성 낮음)
  - `always` : 각 명령어를 aof파일에 기록하고 나서 항상 `fsync` 호출 (느리지만 안정성 좋음)
  - `everysec` : 매 초마다 `fsync` 호출

- `noappendfsync-on-rewrite`
  - `appendfsync` 설정이 `always`, `everysec`인 경우 AOF, 스냅샷을 생성하기 위한  
    백그라운드 프로세스가 동작하면 리눅스가 `fsync`함수를 블록 시킬 수 있음
  - 이 설정을 사용하면 백그라운드 프로세스가 동작하는 동안 `appendfsync`설정이 `no`처럼 동작
    - 데이터의 안정성 보다 응답시간이 중요할 경우 사용

***

## 복제 설정

- `slaveof <마스터 노드 IP> <마스터 노드 포트>`
  - 마스터 노드의 네트워크 상의 위치 지정

- `masterauth`
  - 마스터 노드가 `requirepass`설정에 의해 PW로 보호될 경우 사용
  - 마스터 노드로 접근할 때 사용할 PW 지정

- `slave-serve-stale-data`
  - 특정 상황의 슬레이브 노드의 동작 방법 지정
    - 마스터 노드와 네트워크 연결이 끊겼을 때
    - 마스터 노드의 전체 데이터를 복제중 일 때
  - 이 상태일 때는 슬레이브 노드의 데이터가 최신의 데이터가 아니라는 전제 하에 사용
  - `no`로 설정 시 모든 요청은 `SYNC with master in progress` 응답을 받음

- `slave-read-only`
  - 슬레이브 노드의 쓰기 명령 처리 정책 지정
  - `yes` 사용 시 슬레이브 노드는 쓰기 명령을 모두 거부

- `repl-ping-slave-period`
  - 설정된 간격으로 마스터 노드에 `ping` 명령 전송
  - 기본값 : 10초

***

## 보안 설정

- `requirepass`
  - 레디스 서버에 접속하기위한 패스워드 설정
  - 클라이언트는 이 설정에 지정한 값을 사용하여 인증한 후에 레디스 명령 사용 가능

- `rename-command <기존 명령어> <바꿀 명령어>`
  - 이 설정에 지정된 레디스 명령을 다른 이름으로 변경
  - `select`명령 같은 경우 `""` 문자열로 바꿈으로써 클라이언트에서 접근 불가로 변경가능
  - 복제 설정이나 AOF에서 문제 발생 가능성이 존재 (각 노드 설정이 다른 경우 발생)

***

## 최댓값 제한 설정

- `maxclients`
  - 레디스 인스턴스에 접속 가능한 클라이언트 수
  - 리눅스의 경우 프로세스별 파일 디스크립터 개수 제한으로 설정과 다를 수 있음

- `maxmemory`
  - 레디스 인스턴스가 데이터를 저장하기 위해 사용할 메모리의 크기

- `maxmemory-policy`
  - 저장된 데이터의 크기가 `maxmemory` 설정 값을 넘어갈 경우 저장된 데이터 처리 정책
  - `volatile-lru` : `expire` 명령 기준 만료된 키를 대상으로 최근 적게 사용된 키 제거
  - `allkeys-lru` : 모든 키 중에서 최근에 가장 사용이 적은 키 제거
  - `volatile-random` : 만료된 키 중 아무거나 제거
  - `allkeys-random` : 모든 키 중 아무거나 제거
  - `noeviction` : 어떤 키도 제거하지 않음
  - 어떤 설정이는 데이터를 저장할 공간이 확보되지 않으면 쓰기 연산 실패처리

- `maxmemory-samples`
  - `maxmemory-policy` 정책 적용을 위해 레디스가 조회할 키의 개수 지정
  - 삭제할 키를 찾을 때 정렬을 하지 않기 때문에 정확한 조건에 맞는 키를 찾지 않을 수 있음
  - 때문에 임의의 키를 몇 개 조회하여 조건에 가장 근접한 키를 선정

***

## 슬로우 쿼리

- 느리게 수행되는 레디스 명령을 확인하는 방법존재
- 슬로우 쿼리의 정확한 기준은 레디스 인스턴스에 도착한 명령이 결과를 내기까지의 시간
  - 네트워크 전송시간, 입출력 시간은 제외

- `slowlog-log-slower-than`
  - 얼마나 많은 시간이 걸리는 명령을 슬로우 쿼리에 저장할지 설정
  - `ms`단위로 시간 설정
  - 지정된 개수보다 많은 로그가 생성되면 가장 오래된 로그를 지우고 새로운 로그 추가

- `slowlog-max-len`
  - 몇 개의 슬로우 쿼리를 저장할 지 지정
  - 로그는 레디스의 메모리에 저장됨
  - 저장된 슬로우 로그를 조회하는데 `slowlog [option]` 레디스 명령 사용
    - `len` : 슬로우 쿼리의 개수 조회
    - `reset` : 슬로우 쿼리 목록 제거
    - `get <number>` : 레디스가 저장한 슬로우 쿼리 조회
  - 기본값 : 128

***

## 루아 설정

- 레디스 서버에서 루아 스크립트를 실행할 때 사용하는 설정
- 루아 스크립트는 원자성을 띄며 레디스는 단일 스레드이므로 동시에 다른 요청 처리 불가
- 때문에 루아 관련 설정은 실행 제한 시간과 관련이 있음

- `lua-time-limit`
  - 루아 스크립트가 실행될 최대 시간 (`ms`단위)
  - 해당 시간이 지나면 `script kill`명령에 의해 루아 스크립트가 중지될 수 있음
  - 루아 스크립트 실행 시간 제한이 없다면 `script kill`명령으로 강제 중지할 수 없음

***

## 데이터 인코딩 설정

- 참조 : 08_Redis_내부구조.md

- 해시 데이터 인코딩 설정
  - `hash-max-ziplist-entries`
  - `hash-max-ziplist-value`

- 리스트 데이터 인코딩 설정
  - `list-max-ziplist-entries`
  - `list-max-ziplist-value`

- 셋 데이터 인코딩 설정
  - `set-max-intset-entries`

- 정렬된 셋 데이터 인코딩 설정
  - `zset-max-ziplist-entries`
  - `zset-max-ziplist-value`

***

## 기타 설정

- `client-output-buffer-limit <client> <hard-limit> <soft-limit time>`
  - 레디스 인스턴스는 접속된 클라이언트로 데이터를 전송하기 위해 버퍼 생성
  - 레디스 인스턴스의 입장에서 클라이언트 연결을 세 가지 종류 존재
    - `normal` : 레디스 클라이언트 라이브러리 등을 이용한 일반적 접근
    - `slave` : 복제를 위한 슬레이브 노드로부터의 마스터 노드 접근
    - `pubsub` : pub/sub 명령을 수행중인 클라이언트
  - 두 종류 모두 클라이언트라고 인식하며 데이터 크기에 따라 버퍼의 크기가 결정됨
  - 많은 연결로 인해 버퍼를 할당하여 데이터를 저장할 메모리가 부족한 경우 발생
  - 때문에 이 설정으로 위의 상황 방지
  - `Hard limit` : 버퍼가 특정 크기만큼 커지면 연결 해제
  - `Soft limit` : 버퍼가 특정 크기만큼 커진 상태가 특정 시간만큼 유지되면 연결 해제
  - ex) `client-output-buffer-limit slave 256MB 64MB 60`
    - 슬레이브 노드를 위한 버퍼의 크기가 256MB까지 커지거나
    - 혹은 64MB까지 커진 상태가 60초간 지속되면 슬레이브 노드와의 연결 해제

## 설정 파일 include

- 설정 파일을 따로 분리하여 `include`할 수 있음

```conf
# 레디스 기본 설정
port 6379
loglevel notice
...
include /var/redis-stable/slave.conf
```

```conf
# salve.conf
salveof 192.168.56.103 6379
masterauth foobar
```