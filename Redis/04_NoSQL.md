# NoSQL

## NoSQL의 개념과 정의

- NoSQL은 공식적으로 정의된 바 없으며 워낙 제각각인 NoSQL이 존재
- 오픈소스 분산 데이터베이스 토론 모임의 이름에서 유래
- 마틴 파울러 [NoSQL : 빅데이터 세상으로 떠나는 간결한 안내서]에서는 다음과 같이 소개
  - 대용량 웹 서비스를 위하여 만들어진 데이터 저장소
  - 관계형 데이터 모델을 지양하며 대량의 분산된 데이터를 저장하고 조회하는 데 특화된 저장소
  - 스키마 없이 사용 가능하거나 느슨한 스키마를 제공하는 저장소

***

## CAP 정리

- Consistency(일관성), Availability(가용성), Partition Tolerance(분할 허용성)
- 세 가지를 동시에 지원하는 분산 컴퓨터 시스템은 없음
- 웹 서버와 DB 서버를 다른 하드웨어에 설치하는 것처럼 NoSQL도 분산 컴퓨팅 환경에 잘 동작
- 이때 CAP 중 두 가지 속성만을 지원하고 나머지 한 속성은 특정 조건에서 만족
- 세 가지 속성 중 어떤 두 가지 속성을 만족하느냐에 따라 NoSQL의 특성이 달라짐
- 용어 설명
  - 노드 : 분산 시스템을 구성하는 각각의 하드웨어 or 소프트웨어
  - 클러스터 : 동일한 기능을 수행하는 노드들의 모음
  - 분산 시스템 : 하나 이상의 다중 클러스터로 구성됨
  - 클러스터 간의 연결은 네트워크를 기반
- 레디스는 일관성, 분할 허용성을 만족하는 NoSQL

***

## 일관성

- 동시성(동일성)
- 같은 시간에 조회하는 데이터는 항상 동일한 데이터임을 보장
- 가용성과 분할 허용성을 지원하는 NoSQL은 일관성이 느슨하게 처리됨
  - 같은 시간에 조회해도 다른 데이터로 보일 수 있다는 것
- 대부분 시간이 지남에 따라 수정된 내용이 다른 노드로 전파되어 반영
  - 수정된 내용이 다른 노드로 전파되기까지 시간이 필요
  - 다른 노드를 확인하는 클라이언트는 다른 값을 조회할 가능성 존재함
- 최종 일관성(Eventual Consistency) - 시간이 지남에 따라 최종적으로는 일관성이 유지됨
- NoSQL은 분산 노드간의 데이터 도익화를 위해 두 가지 방법 사용
  - 동기식 방법
    - 데이터의 갱신 결과를 클라이언트로 응답하기 전에 모든 노드에 데이터를 갱신
    - 데이터 갱신이 완료되기까지 응답을 할 수없음
    - 강한 데이터의 정합성 보장
  - 비동기식 방법
    - 데이터의 갱신을 메모리나 임시 파일에 기록하고 클라이언트에게 먼저 응답처리
    - 그 후, 특정 이벤트나 프로세스를 사용하여 다른 노드로 데이터 동기화
    - 빠른 응답이 가능하나 쓰기 노드에 장애 발생시 데이터를 잃어버릴 수 있음
- 많은 NoSQL 솔루션은 읽기, 쓰기 성능 향상을 위해 데이터를 메모리에 임시저장 후 응답
  - 백그라운드 스레드로 해당 데이터를 디스크에 기록
  - 빠른 응답 속도와 데이터 변경 수정 비용이 작음
  - 하드웨어 장애 발생 시 데이터 유실 발생 위험 큼
  - 레디스는 `AOF(Append Only File)` 기능을 사용하여 메모리에 저장 전 파일에 정보 기록

***

## 가용성

- 내고장성
- 모든 클라이언트의 읽기와 쓰기 요청에 대하여 항상 응답이 가능해야 함
- NoSQL 클러스터 내에서 노드 몇 개에 장애가 생기더라도 정상적인 서비스가 가능해야 함
- 가용성을 위한 데이터 중복 저장 방법
  - `Master-Slave`
    - 동일한 데이터를 가진 저장소를 복제
    - 관계형 데이터베이스 시스템에서 고가용성을 지원하기 위해 사용되기도 함
  - `Peer-to-Peer`
    - 데이터 단위로 중복 저장
- `SPOF(Single Point Of Faliure)` 단일 고장점
  - 시스템을 구성하는 개별 요소 중에서 하나의 요소가 망가졌을 때 시스템 전체가 멈추는 요소
  - 이 요소를 가진 NoSQL은 자체적으로 가용성을 지원하기 위한 솔루션을 별도로 제공해야 함

***

## 네트워크 분할 허용성

- 지역적으로 분할된 네트워크 환경하에 동작하는 시스템기준
  - 두 지역 간의 네트워크가 단절되거나
  - 네트워크 데이터의 유실이 일어나도
  - 각 지역내의 시스템은 정상 동작해야함
- 서로 떨어진 노드를 사용하여 클러스터를 구성한다고 가정
  - 네트워크 장애로 두 노드가 통신이 불가능한 경우
  - 각 노드에 접속하는 클라이언트가 데이터 읽기/쓰기가 정상적으로 작동해야함

***

## 키-값 모델 NoSQL

- NoSQL은 데이터의 저장 방식에 따라 분류되기도 함
- 그중에서도 레디스는 키-값 모델에 속함
- Key-Value 모델 NoSQL은 가장 기본적인 형태의 NoSQL
- 키 하나로 데이터 하나를 저장하고 조회할 수 있는 단일 키-값 구조

### 공통 특징

- 대부분의 키-값 모델 NoSQL은 단순한 저장구조로 복잡한 조회 연산을 지원하지 않음
- 고속 읽기와 쓰기에 최적화된 경우가 많음
- 다른 모델의 NoSQL과 비교하여 API가 단순

### 데이터 저장 방법

- 단일 키에 단일 데이터를 저장하는 간단한 구조
- 주로 다순한 정보의 빠른 저장과 조회 제공
- 상황에 따라 복잡한 정보를 저장하기 위해 키에 정보를 포함하도록 하는 키 설계 기법 사용

### 주 사용처

- 사용자 프로필 정보, 웹 서버의 클러스터를 위한 세션 정보, 장바구니 정보, URL 단축 정보 등
- 단일 연산에 의하여 처리를 완료하거나 취소가 가능한 경우에 적절

***

## NoSQL을 언제 사용해야 하는가

- 대량의 단순 정보를 빠르게 저장하고 조회하는 경우
- RDB가 처리하지 못하는 대량의 데이터를 입력할 때
- 스키마가 고정되지 않은 데이터를 저장하고 조회할 때 등

## 어떤 NoSQL을 사용해야 하는가

- 관계형 데이터베이스에서 NoSQL로 변경할 경우 고려해야 할 사항
  - 일관성 모델 : 강한 일관성 모델이 필요한지, 느슨한 일관성 모델도 괜찮은지
  - 데이터 모델 : 키-값 모델같은 간단한 모델로 처리가 가능한지
  - 읽기 쓰기 성능 : 제공할 기능의 읽기 쓰기 비율 (높은 읽기, 쓰기 성능 - 인메모리 사용)
  - 단일 고장점 : 선택한 NoSQL의 단일 고장점 고려
  - 원자성 지원 : 트랜잭션 지원 여부, 단일 연산에 대한 원자성 지원 여부
  - 하드웨어 구성 : 시스템 아키텍쳐 확인 필요 (가용성 - Master-Slave 구조)
  - 무중단 시스템 : 시스템 확장시 시스템 중단이 필요한지 여부